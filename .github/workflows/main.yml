name: Secure Windows RDP via Tailscale

on:
  workflow_dispatch:
    inputs:
      session_timeout:
        description: 'Session timeout in minutes (10-360)'
        required: false
        default: '120'
        type: string

env:
  RDP_USERNAME: 'RDP-Admin'

jobs:
  secure-rdp-session:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON(inputs.session_timeout) }}

    steps:
      - name: Check Session Timeout
        run: |
          $timeout = [int]${{ inputs.session_timeout }}
          if ($timeout -lt 10 -or $timeout -gt 360) {
            Write-Error "Timeout must be between 10 and 360 minutes"
            Write-Output "::error::Session timeout must be between 10 and 360 minutes"
            exit 1
          }
          Write-Host "‚úÖ Session will timeout after $timeout minutes"

      - name: Configure Windows RDP
        run: |
          Write-Host "üîß Configuring Windows RDP..."
          
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Set security level
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 1 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1 -Force
          
          # Configure firewall
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          
          # Restart RDP service
          Restart-Service -Name TermService -Force
          
          Write-Host "‚úÖ RDP configured successfully"

      - name: Create RDP User Account
        run: |
          Write-Host "üë§ Creating RDP user account..."
          
          # Simple password generation
          $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 16 | ForEach-Object {[char]$_})
          
          # Add some special characters
          $specialChars = @('!','@','#','$','%','^','&','*','_','+','-','=')
          $password = $password.Insert(4, ($specialChars | Get-Random))
          $password = $password.Insert(8, ($specialChars | Get-Random))
          
          # Mask password in logs
          Write-Host "::add-mask::$password"
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Create or update user
          try {
              New-LocalUser -Name $env:RDP_USERNAME -Password $securePass -AccountNeverExpires
              Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USERNAME
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USERNAME
          } catch {
              # User might already exist, try to update password
              Set-LocalUser -Name $env:RDP_USERNAME -Password $securePass
          }
          
          # Store credentials
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          Write-Host "‚úÖ User account configured: $env:RDP_USERNAME"

      - name: Install Tailscale with Winget
        run: |
          Write-Host "üì¶ Installing Tailscale using Winget..."
          
          # Check if winget is available
          $wingetCheck = Get-Command winget -ErrorAction SilentlyContinue
          if ($wingetCheck) {
              Write-Host "‚úÖ Winget is available"
              
              # Try to install Tailscale using winget
              try {
                  Write-Host "Installing Tailscale via Winget..."
                  winget install --id Tailscale.Tailscale --silent --accept-package-agreements --accept-source-agreements
                  Write-Host "‚úÖ Tailscale installed via Winget"
              } catch {
                  Write-Host "‚ùå Winget installation failed: $_"
                  Write-Host "Trying MSI installation..."
                  Install-MsiFallback
              }
          } else {
              Write-Host "‚ùå Winget not available"
              Write-Host "Using MSI installation..."
              Install-MsiFallback
          }

      - name: Verify Tailscale Installation
        run: |
          Write-Host "üîç Verifying Tailscale installation..."
          
          # Check for Tailscale executable
          $possiblePaths = @(
              "$env:ProgramFiles\Tailscale ailscale.exe",
              "${env:ProgramFiles(x86)}\Tailscale ailscale.exe",
              "C:\Program Files\Tailscale ailscale.exe"
          )
          
          $tailscaleFound = $false
          
          foreach ($path in $possiblePaths) {
              if (Test-Path $path) {
                  Write-Host "‚úÖ Found Tailscale at: $path"
                  echo "TAILSCALE_PATH=$path" >> $env:GITHUB_ENV
                  $tailscaleFound = $true
                  break
              }
          }
          
          if (-not $tailscaleFound) {
              Write-Host "‚ùå Tailscale not found in standard locations"
              Write-Host "Checking installed programs..."
              
              # Check via registry
              $uninstallKeys = @(
                  "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
                  "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
              )
              
              $tailscaleInfo = $null
              foreach ($key in $uninstallKeys) {
                  $tailscaleInfo = Get-ItemProperty $key -ErrorAction SilentlyContinue | 
                      Where-Object { $_.DisplayName -like "*Tailscale*" } | 
                      Select-Object -First 1
                  if ($tailscaleInfo) { break }
              }
              
              if ($tailscaleInfo) {
                  Write-Host "‚úÖ Tailscale is registered in Windows:"
                  Write-Host " Name: $($tailscaleInfo.DisplayName)"
                  Write-Host " Version: $($tailscaleInfo.DisplayVersion)"
                  Write-Host " InstallLocation: $($tailscaleInfo.InstallLocation)"
                  
                  # Try to construct path
                  if ($tailscaleInfo.InstallLocation) {
                      $possibleExe = Join-Path $tailscaleInfo.InstallLocation "tailscale.exe"
                      if (Test-Path $possibleExe) {
                          echo "TAILSCALE_PATH=$possibleExe" >> $env:GITHUB_ENV
                          $tailscaleFound = $true
                      }
                  }
              }
              
              if (-not $tailscaleFound) {
                  Write-Host "‚ö†Ô∏è Tailscale seems to be installed but executable not found"
                  Write-Host "Will use default path: C:\Program Files\Tailscale ailscale.exe"
                  echo "TAILSCALE_PATH=C:\Program Files\Tailscale ailscale.exe" >> $env:GITHUB_ENV
              }
          }

      - name: Connect to Tailscale
        run: |
          Write-Host "üîó Connecting to Tailscale..."
          
          $hostname = "github-rdp-$env:GITHUB_RUN_ID"
          Write-Host "Hostname: $hostname"
          
          $tailscalePath = $env:TAILSCALE_PATH
          
          Write-Host "Using Tailscale path: $tailscalePath"
          
          # Try to connect even if path might not exist
          $maxAttempts = 3
          
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
              Write-Host "Connection attempt $attempt of $maxAttempts..."
              
              try {
                  if (Test-Path $tailscalePath) {
                      & $tailscalePath up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$hostname --accept-routes=false --reset
                      
                      # Wait for IP
                      $tsIP = $null
                      for ($i = 1; $i -le 10; $i++) {
                          $tsIP = & $tailscalePath ip -4 2>$null
                          if ($tsIP -and $tsIP.Trim() -ne "") {
                              Write-Host "‚úÖ Tailscale IP obtained: $tsIP"
                              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
                              break 2 # Break out of both loops
                          }
                          Start-Sleep -Seconds 2
                      }
                  } else {
                      Write-Host "‚ö†Ô∏è Tailscale executable not found at $tailscalePath"
                      
                      # Try alternative method
                      Write-Host "Starting Tailscale service..."
                      Start-Service "Tailscale" -ErrorAction SilentlyContinue
                      Start-Sleep -Seconds 5
                      
                      # Check if service started
                      $service = Get-Service "Tailscale" -ErrorAction SilentlyContinue
                      if ($service.Status -eq 'Running') {
                          Write-Host "‚úÖ Tailscale service is running"
                          echo "TAILSCALE_IP=service-running" >> $env:GITHUB_ENV
                          break
                      }
                  }
              } catch {
                  Write-Host "Attempt $attempt failed: $_"
                  if ($attempt -eq $maxAttempts) {
                      Write-Host "‚ùå All connection attempts failed"
                      echo "TAILSCALE_IP=connection-failed" >> $env:GITHUB_ENV
                  }
              }
              
              Start-Sleep -Seconds 5
          }

      - name: Get Network Information
        run: |
          Write-Host "üìä Getting network information..."
          
          # Get local IP address
          $localIP = (Get-NetIPAddress -AddressFamily IPv4 -InterfaceAlias "Ethernet*" | Where-Object {$_.PrefixOrigin -eq 'Dhcp'} | Select-Object -First 1).IPAddress
          if (-not $localIP) {
              $localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -like "10.*" -or $_.IPAddress -like "192.168.*"} | Select-Object -First 1).IPAddress
          }
          
          echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
          Write-Host "üîó Local IP: $localIP"
          
          # Try to get public IP
          try {
              $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 10).Trim()
              echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
              Write-Host "üåê Public IP: $publicIP"
          } catch {
              Write-Host "‚ö†Ô∏è Could not get public IP"
              echo "PUBLIC_IP=unknown" >> $env:GITHUB_ENV
          }
          
          Write-Host "‚úÖ Network information gathered"

      - name: Display Connection Information
        run: |
          Write-Host ""
          Write-Host "‚ïê" * 60
          Write-Host "üöÄ WINDOWS RDP SESSION READY"
          Write-Host "‚ïê" * 60
          Write-Host ""
          
          Write-Host "üë§ Authentication:"
          Write-Host " Username: $env:RDP_USERNAME"
          Write-Host " Password: $env:RDP_PASSWORD"
          
          Write-Host ""
          Write-Host "üîó Connection Options:"
          
          # Option 1: Tailscale
          if ($env:TAILSCALE_IP -and $env:TAILSCALE_IP -notin @('service-running', 'connection-failed', 'unknown')) {
              Write-Host " 1. Tailscale (Recommended - Secure):"
              Write-Host " IP Address: $env:TAILSCALE_IP"
              Write-Host " Command: mstsc /v:$env:TAILSCALE_IP"
          } else {
              Write-Host " 1. Tailscale: Installation or connection issue"
              Write-Host " Status: $env:TAILSCALE_IP"
          }
          
          # Option 2: Public IP
          if ($env:PUBLIC_IP -and $env:PUBLIC_IP -ne 'unknown') {
              Write-Host ""
              Write-Host " 2. Public IP (Less Secure - Firewall open on port 3389):"
              Write-Host " IP Address: $env:PUBLIC_IP"
              Write-Host " Command: mstsc /v:$env:PUBLIC_IP"
              Write-Host " Warning: Ensure your firewall is properly configured!"
          }
          
          # Option 3: Local IP
          if ($env:LOCAL_IP) {
              Write-Host ""
              Write-Host " 3. Local Network (If in same network):"
              Write-Host " IP Address: $env:LOCAL_IP"
              Write-Host " Command: mstsc /v:$env:LOCAL_IP"
          }
          
          Write-Host ""
          Write-Host "‚è∞ Session Information:"
          Write-Host " Session will end in: ${{ inputs.session_timeout }} minutes"
          Write-Host " Started: $(Get-Date)"
          Write-Host " Ends: $(Get-Date).AddMinutes(${{ inputs.session_timeout }})"
          
          Write-Host ""
          Write-Host "üìã Notes:"
          Write-Host " ‚Ä¢ For Tailscale connection: Install Tailscale client on your machine"
          Write-Host " ‚Ä¢ Click 'Cancel workflow' in GitHub Actions to end session early"
          Write-Host " ‚Ä¢ Password is randomly generated for this session only"
          
          Write-Host ""
          Write-Host "‚ïê" * 60
          Write-Host ""

      - name: Keep Session Alive
        run: |
          $startTime = Get-Date
          $timeoutMinutes = [int]${{ inputs.session_timeout }}
          $endTime = $startTime.AddMinutes($timeoutMinutes)
          
          Write-Host "‚è≥ Session active. Press 'Cancel workflow' to end early."
          Write-Host " Started: $startTime"
          Write-Host " Will end: $endTime"
          Write-Host ""
          
          # Simple keep-alive loop
          while ($true) {
              $now = Get-Date
              $remaining = $endTime - $now
              
              if ($remaining.TotalSeconds -le 0) {
                  Write-Host "‚è∞ Session timeout reached"
                  break
              }
              
              $minutesLeft = [math]::Round($remaining.TotalMinutes, 1)
              
              # Update every 30 seconds
              if ([math]::Floor(($now - $startTime).TotalSeconds) % 30 -eq 0) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Active - $minutesLeft minutes remaining"
              }
              
              # Keep RDP service running
              $service = Get-Service TermService -ErrorAction SilentlyContinue
              if ($service.Status -ne 'Running') {
                  Write-Host "‚ö†Ô∏è RDP service stopped, restarting..."
                  Start-Service TermService -ErrorAction SilentlyContinue
              }
              
              Start-Sleep -Seconds 1
          }
          
          Write-Host "üõë Session ended at $(Get-Date)"
