name: RDP via Tailscale

on:
  workflow_dispatch:

env:
  TS_VERSION: "1.82.0"
  RDP_PORT: 3389
  RDP_USERNAME: "RDP"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Configure RDP Settings
        run: |
          # å¯ç”¨è¿œç¨‹æ¡Œé¢
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # ç¦ç”¨ç½‘ç»œçº§åˆ«èº«ä»½éªŒè¯(NLA)ä»¥ä¾¿è¿žæŽ¥
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force
          
          # é…ç½®é˜²ç«å¢™
          Write-Host "é…ç½®é˜²ç«å¢™è§„åˆ™..."
          
          # ç§»é™¤çŽ°æœ‰è§„åˆ™
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall delete rule name="RemoteDesktop" 2>$null
          
          # å…è®¸RDPè¿žæŽ¥
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=$env:RDP_PORT
          
          # é‡å¯æœåŠ¡
          Restart-Service -Name TermService -Force
          Start-Sleep -Seconds 3
          
          Write-Host "âœ… RDPé…ç½®å®Œæˆ"

      - name: Create RDP User
        run: |
          Write-Host "åˆ›å»º RDP ç”¨æˆ·..."
          
          # ç§»é™¤çŽ°æœ‰ç”¨æˆ·
          $existingUser = Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
          if ($existingUser) {
            Write-Host "ç§»é™¤çŽ°æœ‰ç”¨æˆ·: $env:RDP_USERNAME"
            Remove-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
          }
          
          # æ–¹æ³•1: ä½¿ç”¨æ›´å¤æ‚çš„å¯†ç ï¼ˆç¬¦åˆWindowså¯†ç ç­–ç•¥ï¼‰
          # Windowså¯†ç ç­–ç•¥è¦æ±‚: è‡³å°‘6ä¸ªå­—ç¬¦ï¼ŒåŒ…å«å¤§å†™ã€å°å†™ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
          $password = "ComplexP@ssw0rd!2024"
          
          Write-Host "å°è¯•ä½¿ç”¨ PowerShell åˆ›å»ºç”¨æˆ·..."
          try {
            $securePass = ConvertTo-SecureString $password -AsPlainText -Force
            New-LocalUser -Name $env:RDP_USERNAME -Password $securePass -AccountNeverExpires -ErrorAction Stop
            Write-Host "âœ… PowerShell ç”¨æˆ·åˆ›å»ºæˆåŠŸ"
          } catch {
            Write-Host "PowerShell æ–¹æ³•å¤±è´¥: $_"
            Write-Host "å°è¯•ä½¿ç”¨ net user å‘½ä»¤..."
            
            # æ–¹æ³•2: ä½¿ç”¨ net user å‘½ä»¤
            net user $env:RDP_USERNAME $password /add /expires:never /passwordchg:no
            if ($LASTEXITCODE -ne 0) {
              Write-Error "net user å‘½ä»¤ä¹Ÿå¤±è´¥äº†"
              exit 1
            }
            Write-Host "âœ… net user å‘½ä»¤æˆåŠŸ"
          }
          
          # æ·»åŠ åˆ°ç»„
          Write-Host "å°†ç”¨æˆ·æ·»åŠ åˆ°ç»„..."
          Add-LocalGroupMember -Group "Administrators" -Member $env:RDP_USERNAME -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $env:RDP_USERNAME -ErrorAction SilentlyContinue
          
          # å¦‚æžœAdd-LocalGroupMemberå¤±è´¥ï¼Œä½¿ç”¨net localgroup
          $userInAdminGroup = net localgroup Administrators | Select-String -Pattern $env:RDP_USERNAME
          if (-not $userInAdminGroup) {
            Write-Host "ä½¿ç”¨ net localgroup æ·»åŠ åˆ° Administrators..."
            net localgroup Administrators $env:RDP_USERNAME /add
          }
          
          $userInRDPGroup = net localgroup "Remote Desktop Users" | Select-String -Pattern $env:RDP_USERNAME
          if (-not $userInRDPGroup) {
            Write-Host "ä½¿ç”¨ net localgroup æ·»åŠ åˆ° Remote Desktop Users..."
            net localgroup "Remote Desktop Users" $env:RDP_USERNAME /add
          }
          
          # éªŒè¯ç”¨æˆ·åˆ›å»º
          $userCheck = Get-LocalUser -Name $env:RDP_USERNAME -ErrorAction SilentlyContinue
          if ($userCheck) {
            Write-Host "âœ… ç”¨æˆ· '$env:RDP_USERNAME' å·²æˆåŠŸåˆ›å»ºå’Œé…ç½®"
            
            # ä¿å­˜å‡­æ®
            echo "RDP_USERNAME=$env:RDP_USERNAME" >> $env:GITHUB_ENV
            echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
            
            # åœ¨æ—¥å¿—ä¸­éšè—å¯†ç 
            Write-Host "::add-mask::$password"
          } else {
            Write-Error "âŒ ç”¨æˆ·åˆ›å»ºå¤±è´¥"
            exit 1
          }

      - name: Install Tailscale
        run: |
          Write-Host "æ­£åœ¨å®‰è£… Tailscale..."
          
          # ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³• - ç›´æŽ¥è¿è¡ŒMSIå®‰è£…
          $installerPath = "$env:TEMP ailscale.msi"
          
          # ä¸‹è½½
          Write-Host "ä¸‹è½½ Tailscale..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $installerPath
          
          # é™é»˜å®‰è£…
          Write-Host "æ­£åœ¨å®‰è£…..."
          cmd /c "msiexec /i `"$installerPath`" /quiet /qn /norestart"
          
          # ç­‰å¾…å®‰è£…å®Œæˆ
          Write-Host "ç­‰å¾…å®‰è£…å®Œæˆ..."
          Start-Sleep -Seconds 15
          
          # æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ
          $tsExe = "C:\Program Files\Tailscale ailscale.exe"
          if (Test-Path $tsExe) {
            Write-Host "âœ… Tailscale å®‰è£…æˆåŠŸ!"
          } else {
            Write-Host "âš ï¸ Tailscale å¯èƒ½æœªå®‰è£…åˆ°é»˜è®¤ä½ç½®ï¼Œå°è¯•æŸ¥æ‰¾..."
            
            # æŸ¥æ‰¾tailscale.exe
            $foundExe = Get-ChildItem -Path "C:\" -Filter "tailscale.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($foundExe) {
              $tsExe = $foundExe.FullName
              Write-Host "æ‰¾åˆ° Tailscale åœ¨: $tsExe"
            } else {
              Write-Host "âŒ æ— æ³•æ‰¾åˆ° Tailscale æ‰§è¡Œæ–‡ä»¶"
              # å°è¯•ç›´æŽ¥è°ƒç”¨ï¼Œå¯èƒ½å·²åœ¨PATHä¸­
              $tsExe = "tailscale.exe"
            }
          }
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "TAILSCALE_EXE=$tsExe" >> $env:GITHUB_ENV

      - name: Connect to Tailscale
        run: |
          Write-Host "=== è¿žæŽ¥åˆ° Tailscale ==="
          
          # ç¡®å®šTailscaleå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
          if ($env:TAILSCALE_EXE) {
            $tsExe = $env:TAILSCALE_EXE
          } else {
            $tsExe = "C:\Program Files\Tailscale ailscale.exe"
          }
          
          Write-Host "ä½¿ç”¨ Tailscale æ‰§è¡Œæ–‡ä»¶: $tsExe"
          
          # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•ç›´æŽ¥è°ƒç”¨ï¼ˆå¯èƒ½å·²åœ¨PATHä¸­ï¼‰
          if (-not (Test-Path $tsExe)) {
            Write-Host "âš ï¸ Tailscale æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œå°è¯•ç›´æŽ¥è°ƒç”¨..."
            $tsExe = "tailscale.exe"
          }
          
          $hostname = "gh-runner-$env:GITHUB_RUN_ID"
          
          # æ£€æŸ¥TailscaleæœåŠ¡
          Write-Host "æ£€æŸ¥ Tailscale æœåŠ¡..."
          $service = Get-Service -Name Tailscale -ErrorAction SilentlyContinue
          if ($service -and $service.Status -ne 'Running') {
            Write-Host "å¯åŠ¨ Tailscale æœåŠ¡..."
            Start-Service -Name Tailscale
          }
          
          Start-Sleep -Seconds 5
          
          # è¿žæŽ¥åˆ° Tailscale
          Write-Host "è¿žæŽ¥åˆ° Tailscaleï¼Œä¸»æœºå: $hostname"
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          
          if ([string]::IsNullOrEmpty($authKey)) {
            Write-Error "TAILSCALE_AUTH_KEY æœªè®¾ç½®ã€‚è¯·æ·»åŠ åˆ°ä»“åº“çš„ Secrets ä¸­ã€‚"
            exit 1
          }
          
          # æ‰§è¡Œè¿žæŽ¥å‘½ä»¤
          & $tsExe up --authkey=$authKey --hostname=$hostname 2>&1
          
          # ç­‰å¾…å¹¶èŽ·å–IP
          $tsIP = $null
          $retries = 0
          
          Write-Host "ç­‰å¾… Tailscale åˆ†é…IP..."
          while (-not $tsIP -and $retries -lt 10) {
            $tsIP = & $tsExe ip -4 2>$null
            
            if (-not $tsIP) {
              Write-Host "å°è¯• $($retries + 1)/10: å°šæœªèŽ·å–IP..."
              Start-Sleep -Seconds 3
              $retries++
            }
          }
          
          if ($tsIP) {
            echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
            Write-Host "âœ… Tailscale IP: $tsIP"
            
            # æ˜¾ç¤ºçŠ¶æ€
            & $tsExe status 2>&1
          } else {
            Write-Error "âŒ æ— æ³•èŽ·å– Tailscale IP"
            Write-Host "è°ƒè¯•ä¿¡æ¯:"
            
            # å°è¯•å…¶ä»–æ–¹æ³•èŽ·å–IP
            Write-Host "å°è¯•é€šè¿‡ status å‘½ä»¤èŽ·å–IP..."
            $status = & $tsExe status 2>&1
            Write-Host $status
            
            # ä»ŽçŠ¶æ€è¾“å‡ºä¸­æå–IP
            if ($status -match '(\d+\.\d+\.\d+\.\d+)') {
              $tsIP = $matches[1]
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
              Write-Host "âœ… ä»ŽçŠ¶æ€ä¸­æå–åˆ° IP: $tsIP"
            } else {
              # ç»§ç»­è¿è¡Œï¼Œä½†è­¦å‘Šç”¨æˆ·
              Write-Host "âš ï¸ æ— æ³•èŽ·å–IPï¼Œä½†ç»§ç»­è¿è¡Œ..."
            }
          }

      - name: Test RDP
        run: |
          if (-not $env:TAILSCALE_IP) {
            Write-Host "âš ï¸ æœªèŽ·å–åˆ° Tailscale IPï¼Œè·³è¿‡æµ‹è¯•"
            exit 0
          }
          
          Write-Host "æµ‹è¯• RDP è¿žæŽ¥åˆ°: $env:TAILSCALE_IP"
          
          # æµ‹è¯•æœ¬åœ°RDP
          Write-Host "1. æµ‹è¯•æœ¬åœ°RDPç«¯å£..."
          $localTest = Test-NetConnection -ComputerName 127.0.0.1 -Port $env:RDP_PORT -WarningAction SilentlyContinue
          if ($localTest.TcpTestSucceeded) {
            Write-Host "âœ… æœ¬åœ°RDPç«¯å£å·²æ‰“å¼€"
          } else {
            Write-Host "âŒ æœ¬åœ°RDPç«¯å£æœªå“åº”"
          }
          
          # é€šè¿‡Tailscale IPæµ‹è¯•
          Write-Host "2. é€šè¿‡ Tailscale IP æµ‹è¯•..."
          try {
            $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port $env:RDP_PORT -WarningAction SilentlyContinue -ErrorAction Stop
            if ($testResult.TcpTestSucceeded) {
              Write-Host "âœ… RDP å¯é€šè¿‡ Tailscale è®¿é—®!"
            } else {
              Write-Host "âš ï¸ TCPæµ‹è¯•å¤±è´¥ï¼Œä½†å¯èƒ½ä»ç„¶å¯ä»¥è¿žæŽ¥"
            }
          } catch {
            Write-Host "âš ï¸ è¿žæŽ¥æµ‹è¯•å¤±è´¥: $_"
          }

      - name: Display Connection Info
        run: |
          $border = "â•" * 50
          
          Write-Host ""
          Write-Host $border
          Write-Host "ðŸš€ RDP å‡†å¤‡å°±ç»ª"
          Write-Host $border
          Write-Host ""
          
          if ($env:TAILSCALE_IP) {
            Write-Host "ðŸŒ è¿žæŽ¥åˆ°:"
            Write-Host " $env:TAILSCALE_IP"
            Write-Host ""
            Write-Host "ðŸ“ å¿«é€Ÿè¿žæŽ¥:"
            Write-Host " mstsc /v:$env:TAILSCALE_IP"
            Write-Host ""
          } else {
            Write-Host "âš ï¸ æ— æ³•èŽ·å– Tailscale IP"
            Write-Host "è¯·æ£€æŸ¥ Tailscale è¿žæŽ¥"
            Write-Host ""
          }
          
          Write-Host "ðŸ”‘ å‡­æ®:"
          Write-Host " ç”¨æˆ·å: $env:RDP_USERNAME"
          Write-Host " å¯†ç : ******** (æŸ¥çœ‹å·¥ä½œæµçŽ¯å¢ƒå˜é‡)"
          Write-Host ""
          Write-Host "âš ï¸ é‡è¦æç¤º:"
          Write-Host " 1. ç¡®ä¿è¿žæŽ¥åˆ°ç›¸åŒçš„ Tailscale ç½‘ç»œ"
          Write-Host " 2. åœ¨è¿œç¨‹æ¡Œé¢å®¢æˆ·ç«¯ä¸­ç¦ç”¨ NLAï¼ˆå¦‚æžœéœ€è¦ï¼‰"
          Write-Host " 3. è¿è¡Œå™¨å°†åœ¨60åˆ†é’ŸåŽè‡ªåŠ¨ç»ˆæ­¢"
          Write-Host ""
          Write-Host $border
          
          # è¾“å‡ºåˆ°æ‘˜è¦
          Write-Output "## è¿žæŽ¥è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          if ($env:TAILSCALE_IP) {
            Write-Output "**IPåœ°å€:** $env:TAILSCALE_IP" >> $GITHUB_STEP_SUMMARY
          }
          Write-Output "**ç”¨æˆ·å:** $env:RDP_USERNAME" >> $GITHUB_STEP_SUMMARY
          Write-Output "" >> $GITHUB_STEP_SUMMARY
          if ($env:TAILSCALE_IP) {
            Write-Output "```" >> $GITHUB_STEP_SUMMARY
            Write-Output "mstsc /v:$env:TAILSCALE_IP" >> $GITHUB_STEP_SUMMARY
            Write-Output "```" >> $GITHUB_STEP_SUMMARY
          }

      - name: Keep Alive
        run: |
          Write-Host "ðŸ”„ è¿è¡Œå™¨æ´»è·ƒä¸­ã€‚åœ¨ GitHub ä¸­ç‚¹å‡» 'Cancel workflow' ç»ˆæ­¢ã€‚"
          Write-Host ""
          
          if ($env:TAILSCALE_IP) {
            Write-Host "è¿žæŽ¥è¯¦æƒ…:"
            Write-Host " IP: $env:TAILSCALE_IP"
          }
          Write-Host " ç”¨æˆ·: $env:RDP_USERNAME"
          Write-Host ""
          
          # ä¿æŒè¿è¡Œ
          $counter = 0
          while ($true) {
            $counter++
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP æ´»è·ƒä¸­ - ç¬¬ $counter åˆ†é’Ÿ"
            
            # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡Tailscaleè¿žæŽ¥
            if ($counter % 5 -eq 0 -and $env:TAILSCALE_IP) {
              Write-Host "æ£€æŸ¥ Tailscale è¿žæŽ¥..."
              $tsExe = if ($env:TAILSCALE_EXE) { $env:TAILSCALE_EXE } else { "tailscale.exe" }
              try {
                & $tsExe status 2>&1 | Out-Null
                Write-Host "Tailscale è¿žæŽ¥æ­£å¸¸"
              } catch {
                Write-Host "Tailscale è¿žæŽ¥æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿žæŽ¥..."
                & $tsExe up --reset 2>&1
              }
            }
            
            Start-Sleep -Seconds 60
          }
