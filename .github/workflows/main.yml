name: Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      RDP_USERNAME: RDP

    steps:
      - name: ğŸ› ï¸ Fix Encoding & Set UTF-8
        run: |
          # é˜²æ­¢ä¸­æ–‡ä¹±ç ï¼Œç¡®ä¿åç»­è„šæœ¬è¾“å‡ºæ­£å¸¸
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          chcp 65001
        shell: powershell

      - name: ğŸ”§ Enable Remote Desktop
        run: |
          Write-Host "ğŸ”„ å¼€å¯è¿œç¨‹æ¡Œé¢æœåŠ¡..." -ForegroundColor Yellow
          
          # 1. å¯ç”¨è¿œç¨‹æ¡Œé¢å¹¶å…³é—­ç½‘ç»œçº§èº«ä»½éªŒè¯
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # 2. é…ç½®é˜²ç«å¢™
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 > $null

          # 3. é‡å¯æœåŠ¡
          Restart-Service -Name TermService -Force
        shell: powershell

      - name: ğŸ” Generate Secure Password
        id: password
        run: |
          Write-Host "ğŸ”‘ ç”Ÿæˆé«˜å¼ºåº¦å¯†ç ..." -ForegroundColor Yellow

          # å®šä¹‰å­—ç¬¦é›† (ä½¿ç”¨æœ€å®‰å…¨çš„æ•°ç»„å®šä¹‰æ–¹å¼)
          $upper = 65..90 | ForEach-Object { [char]$_ } # A-Z
          $lower = 97..122 | ForEach-Object { [char]$_ } # a-z
          $number = 48..57 | ForEach-Object { [char]$_ } # 0-9
          # ç‰¹æ®Šå­—ç¬¦ï¼š!#$%&*+-./:;<=>?@[]^_`{|}~
          $special = 33,35,36,37,38,42,43,45,46,47,58,59,60,61,62,63,64,91,92,93,94,95,96,123,124,125,126 | ForEach-Object { [char]$_ }

          # åˆå¹¶å¹¶éšæœºæ‰“ä¹±ç”Ÿæˆ16ä½å¯†ç 
          $allChars = $upper + $lower + $number + $special
          $password = -join ($allChars | Get-Random -Count 16)

          # å±è”½å¯†ç é˜²æ­¢æ³„éœ²
          Write-Host "::add-mask::$password"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        shell: powershell

      - name: ğŸ‘¤ Create User Account
        run: |
          Write-Host "â• åˆ›å»ºç”¨æˆ· $env:RDP_USERNAME ..." -ForegroundColor Yellow
          
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $username = "$"

          # å¦‚æœç”¨æˆ·å·²å­˜åœ¨åˆ™åˆ é™¤
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $username
          }

          # åˆ›å»ºç”¨æˆ·å¹¶åŠ å…¥ç®¡ç†å‘˜ç»„
          New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "Auto-created RDP account" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        shell: powershell

      - name: ğŸ“¦ Install Tailscale
        run: |
          Write-Host "ğŸ“¦ å®‰è£… Tailscale ..." -ForegroundColor Yellow
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP ailscale.msi"
          
          try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
          } catch {
            Write-Error "å®‰è£…å¤±è´¥: $_"
            exit 1
          }
        shell: powershell

      - name: ğŸŒ Connect to Tailscale
        run: |
          Write-Host "ğŸ”— è¿æ¥ Tailscale ç½‘ç»œ..." -ForegroundColor Yellow
          
          # ä¿®å¤è·¯å¾„æ‹¼æ¥ï¼šä½¿ç”¨ Combine é¿å…è·¯å¾„é”™è¯¯
          $tailscaleExe = [System.IO.Path]::Combine($env:ProgramFiles, "Tailscale", "tailscale.exe")
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $tailscaleExe)) {
            Write-Error "âŒ æœªæ‰¾åˆ° Tailscale å®¢æˆ·ç«¯ï¼Œè¯·æ£€æŸ¥å®‰è£…æ­¥éª¤ã€‚"
            exit 1
          }

          # è¿æ¥èŠ‚ç‚¹
          & $tailscaleExe up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}
          
          # è·å– IP åœ°å€
          $ip = & $tailscaleExe ip -4 2>$null
          if (-not $ip) {
            Write-Error "âŒ æ— æ³•è·å– Tailscale IP"
            exit 1
          }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "âœ… Tailscale è¿æ¥æˆåŠŸï¼ŒIP: $ip" -ForegroundColor Green
        shell: powershell

      - name: ğŸ–¥ï¸ Connection Info & Keep Alive
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "ğŸ‰ å‡†å¤‡å°±ç»ª! è¯·ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯è¿æ¥" -ForegroundColor Green
          Write-Host "åœ°å€: $env:TAILSCALE_IP"
          Write-Host "ç”¨æˆ·å: $env:RDP_USERNAME"
          Write-Host "å¯†ç : $env:RDP_PASSWORD" # ä¼šè¢«æ©ç 
          Write-Host "====================================" -ForegroundColor Green

          # ä¿æŒè¿è¡Œ
          while ($true) {
            Write-Host "[$(Get-Date)] â³ ä¼šè¯ä¿æŒè¿è¡Œä¸­... (åœ¨ GitHub ä¸Šç‚¹å‡» 'Cancel' ä»¥ç»“æŸä¼šè¯)"
