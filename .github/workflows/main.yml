name: Windows RDP Keep Alive with Password

on:
  workflow_dispatch:
    inputs:
      session_timeout:
        description: 'Session duration in minutes (10-480)'
        required: false
        default: '120'
        type: string

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON(inputs.session_timeout) }}

    steps:
      - name: åˆå§‹åŒ–è®¾ç½®
        run: |
          Write-Host "ğŸš€ å¯åŠ¨ Windows RDP ä¼šè¯"
          Write-Host "å·¥ä½œæµ ID: $env:GITHUB_RUN_ID"
          Write-Host "ä¼šè¯æ—¶é•¿: ${{ inputs.session_timeout }} åˆ†é’Ÿ"

      - name: é…ç½®è¿œç¨‹æ¡Œé¢
        run: |
          Write-Host "ğŸ”§ é…ç½®è¿œç¨‹æ¡Œé¢è®¾ç½®..."
          
          # å¯ç”¨ RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # ç¦ç”¨ NLA ä»¥ä¾¿æ›´å¹¿æ³›å…¼å®¹
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force
          
          # é…ç½®é˜²ç«å¢™
          netsh advfirewall firewall delete rule name="GitHub-RDP" 2>$null
          netsh advfirewall firewall add rule `
            name="GitHub-RDP" `
            dir=in action=allow protocol=TCP localport=3389 `
            description="GitHub Actions RDP Session"
          
          # é‡å¯æœåŠ¡
          Restart-Service -Name TermService -Force
          
          Write-Host "âœ… è¿œç¨‹æ¡Œé¢é…ç½®å®Œæˆ"

      - name: åˆ›å»ºç”¨æˆ·å¹¶æ˜¾ç¤ºå¯†ç 
        run: |
          Write-Host "ğŸ‘¤ åˆ›å»º RDP ç”¨æˆ·..."
          
          # ç”Ÿæˆç®€å•æ˜“è®°çš„å¯†ç 
          $randomNum = Get-Random -Minimum 1000 -Maximum 9999
          $password = "RDP$randomNum" + "!"
          
          # åˆ›å»ºç”¨æˆ·
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # åˆ é™¤å·²å­˜åœ¨çš„åŒåç”¨æˆ·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          Remove-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
          
          # åˆ›å»ºæ–°ç”¨æˆ·
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          # ä¿å­˜å¯†ç åˆ°å¤šä¸ªåœ°æ–¹
          $password | Out-File -FilePath "$env:RUNNER_TEMP dp_pwd.txt"
          
          # å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆè™½ç„¶ä¼šè¢«å±è”½ï¼Œä½†ä¸ºäº†å…¶ä»–æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "RDP_USERNAME=RDPUser" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          # å…³é”®ï¼šç›´æ¥è¾“å‡ºå¯†ç åˆ°æ—¥å¿—
          Write-Host ""
          Write-Host "========================================"
          Write-Host "âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼"
          Write-Host "ç”¨æˆ·å: RDPUser"
          Write-Host "å¯†ç : $password"
          Write-Host "========================================"
          Write-Host ""

      - name: è·å–ç½‘ç»œä¿¡æ¯
        run: |
          Write-Host "ğŸŒ è·å–ç½‘ç»œä¿¡æ¯..."
          
          # è·å–å…¬ç½‘ IP
          try {
              $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 5).Trim()
              Write-Host "âœ… å…¬ç½‘IP: $publicIP"
          } catch {
              $publicIP = "æ— æ³•è·å–"
              Write-Host "âš ï¸ æ— æ³•è·å–å…¬ç½‘IP"
          }
          
          # è·å–æœ¬åœ° IP
          $localIP = (Get-NetIPAddress -AddressFamily IPv4 | 
                      Where-Object {$_.IPAddress -ne "127.0.0.1" -and $_.PrefixOrigin -eq "Dhcp"} |
                      Select-Object -First 1).IPAddress
          
          if (-not $localIP) {
              $localIP = (Get-NetIPAddress -AddressFamily IPv4 | 
                         Where-Object {$_.IPAddress -ne "127.0.0.1"} |
                         Select-Object -First 1).IPAddress
          }
          
          Write-Host "ğŸ”— æœ¬åœ°IP: $localIP"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
          
          # åˆ›å»ºè¿æ¥ä¿¡æ¯æ–‡ä»¶
          $connectionInfo = @"
RDP è¿æ¥ä¿¡æ¯
============
æ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
å·¥ä½œæµ: $env:GITHUB_RUN_ID

ç”¨æˆ·å: RDPUser
å¯†ç : $(Get-Content "$env:RUNNER_TEMP dp_pwd.txt")

è¿æ¥åœ°å€:
1. å…¬ç½‘IP: $publicIP
2. æœ¬åœ°IP: $localIP

è¿æ¥å‘½ä»¤:
mstsc /v:$publicIP
æˆ–
mstsc /v:$localIP

ä¼šè¯æ—¶é•¿: ${{ inputs.session_timeout }} åˆ†é’Ÿ
"@
          
          $connectionInfo | Out-File -FilePath "$env:RUNNER_TEMP\connection_info.txt"

      - name: æµ‹è¯• RDP è¿æ¥
        run: |
          Write-Host "ğŸ§ª æµ‹è¯• RDP ç«¯å£..."
          Start-Sleep -Seconds 3
          
          $portTest = Test-NetConnection -ComputerName 127.0.0.1 -Port 3389 -InformationLevel Quiet
          if ($portTest) {
              Write-Host "âœ… RDP ç«¯å£ 3389 å·²å¼€æ”¾"
          } else {
              Write-Host "âš ï¸ RDP ç«¯å£æµ‹è¯•å¤±è´¥ï¼Œä½†å¯èƒ½ä»å¯è¿æ¥"
          }

      - name: æ˜¾ç¤ºè¿æ¥ä¿¡æ¯ï¼ˆå¯†ç åœ¨æ­¤æ˜¾ç¤ºï¼‰
        run: |
          # ä»æ–‡ä»¶è¯»å–å¯†ç 
          $password = Get-Content "$env:RUNNER_TEMP dp_pwd.txt" -Raw
          
          Write-Host ""
          Write-Host "ğŸš¨ğŸš¨ğŸš¨ é‡è¦ï¼šç«‹å³å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼ ğŸš¨ğŸš¨ğŸš¨"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ” ç™»å½•å‡­æ®ï¼š"
          Write-Host " ç”¨æˆ·å: RDPUser"
          Write-Host " å¯†ã€€ç : $password"
          Write-Host ""
          Write-Host "ğŸ“ è¿æ¥åœ°å€ï¼š"
          Write-Host " å…¬ç½‘IP: $env:PUBLIC_IP"
          Write-Host " æœ¬åœ°IP: $env:LOCAL_IP"
          Write-Host ""
          Write-Host "ğŸ’» å¿«é€Ÿè¿æ¥å‘½ä»¤ï¼š"
          Write-Host " mstsc /v:$env:PUBLIC_IP"
          Write-Host " æˆ–"
          Write-Host " mstsc /v:$env:LOCAL_IP"
          Write-Host ""
          Write-Host "â° ä¼šè¯ä¿¡æ¯ï¼š"
          Write-Host " æ—¶é•¿: ${{ inputs.session_timeout }} åˆ†é’Ÿ"
          Write-Host " å·¥ä½œæµID: $env:GITHUB_RUN_ID"
          Write-Host ""
          Write-Host "ğŸ“ æ³¨æ„ï¼š"
          Write-Host " 1. ç«‹å³å¤åˆ¶å¯†ç ï¼Œçª—å£ä¸ä¼šå…³é—­"
          Write-Host " 2. ä¼šè¯å°†æŒç»­ ${{ inputs.session_timeout }} åˆ†é’Ÿ"
          Write-Host " 3. è¦æå‰ç»“æŸï¼Œç‚¹å‡» 'Cancel workflow'"
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""

      - name: ä¸Šä¼ è¿æ¥ä¿¡æ¯ä¾›ä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: rdp-connection-details
          path: |
            ${{ runner.temp }}/rdp_pwd.txt
            ${{ runner.temp }}/connection_info.txt
          retention-days: 1

      - name: ä¿æŒä¼šè¯è¿è¡Œï¼ˆä¸ä¼šç»“æŸï¼‰
        run: |
          $startTime = Get-Date
          $timeoutMinutes = [int]${{ inputs.session_timeout }}
          $endTime = $startTime.AddMinutes($timeoutMinutes)
          
          # æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
          Write-Host ""
          Write-Host "ğŸŸ¢ RDP ä¼šè¯å·²å¯åŠ¨ï¼Œæ­£åœ¨è¿è¡Œ..."
          Write-Host " å¼€å§‹æ—¶é—´: $startTime"
          Write-Host " ç»“æŸæ—¶é—´: $endTime"
          Write-Host " å‰©ä½™æ—¶é—´: $timeoutMinutes åˆ†é’Ÿ"
          Write-Host ""
          
          # å†æ¬¡æ˜¾ç¤ºè¿æ¥ä¿¡æ¯ï¼ˆæ–¹ä¾¿æŸ¥çœ‹ï¼‰
          $password = Get-Content "$env:RUNNER_TEMP dp_pwd.txt" -Raw
          Write-Host "ğŸ“‹ è¿æ¥ä¿¡æ¯æ±‡æ€»ï¼š"
          Write-Host " ç”¨æˆ·å: RDPUser"
          Write-Host " å¯†ã€€ç : $password"
          Write-Host " å…¬ç½‘IP: $env:PUBLIC_IP"
          Write-Host " æœ¬åœ°IP: $env:LOCAL_IP"
          Write-Host ""
          Write-Host "ğŸ”§ ä½¿ç”¨è¿œç¨‹æ¡Œé¢è¿æ¥ (mstsc.exe) è¾“å…¥ä¸Šè¿°ä¿¡æ¯"
          Write-Host "âŒ è¦ç»“æŸä¼šè¯ï¼šç‚¹å‡» GitHub Actions ä¸­çš„ 'Cancel workflow'"
          Write-Host ""
          
          # å¿ƒè·³å¾ªç¯ - ä¿æŒå·¥ä½œæµè¿è¡Œ
          $checkCount = 0
          while ($true) {
              $now = Get-Date
              $remaining = $endTime - $now
              
              # æ£€æŸ¥æ˜¯å¦è¶…æ—¶
              if ($remaining.TotalSeconds -le 0) {
                  Write-Host "â° ä¼šè¯è¶…æ—¶ï¼Œè‡ªåŠ¨ç»“æŸ"
                  break
              }
              
              # æ¯åˆ†é’Ÿæ˜¾ç¤ºä¸€æ¬¡çŠ¶æ€
              if ($checkCount % 60 -eq 0) {
                  $minutesLeft = [math]::Round($remaining.TotalMinutes, 1)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ä¼šè¯æ´»è·ƒ - å‰©ä½™ $minutesLeft åˆ†é’Ÿ"
                  
                  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æœåŠ¡çŠ¶æ€
                  if ($checkCount % 300 -eq 0) {
                      $rdpService = Get-Service TermService -ErrorAction SilentlyContinue
                      if ($rdpService.Status -ne 'Running') {
                          Write-Host "âš ï¸ RDP æœåŠ¡åœæ­¢ï¼Œæ­£åœ¨é‡å¯..."
                          Start-Service TermService -Force -ErrorAction SilentlyContinue
                      }
                  }
              }
              
              $checkCount++
              Start-Sleep -Seconds 1 # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
          }
          
          Write-Host "ğŸ›‘ ä¼šè¯å·²ç»“æŸäº $(Get-Date)"
