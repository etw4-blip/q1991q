name: Windows RDP with Visible Password

on:
  workflow_dispatch:
    inputs:
      session_timeout:
        description: 'Session duration in minutes'
        required: false
        default: '60'
        type: string

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON(inputs.session_timeout) }}

    steps:
      - name: å¯ç”¨è¿œç¨‹æ¡Œé¢
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-å…¬å¼€" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force
          Write-Host "âœ… è¿œç¨‹æ¡Œé¢å·²å¯ç”¨"

      - name: åˆ›å»ºç”¨æˆ·å¹¶ç”Ÿæˆå¯†ç 
        run: |
          # ç”Ÿæˆç®€å•å¯†ç ï¼šRDP + éšæœº6ä½æ•°å­—
          $randomNum = Get-Random -Minimum 100000 -Maximum 999999
          $password = "RDP$randomNum"
          
          # åˆ›å»ºç”¨æˆ·
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          # å°†å¯†ç ä¿å­˜åˆ°æ–‡ä»¶
          $password | Out-File -FilePath "$env:RUNNER_TEMP\password.txt"
          
          # å…³é”®ï¼šç›´æ¥è¾“å‡ºå¯†ç ï¼ˆä¸ä½¿ç”¨add-maskï¼‰
          Write-Host "=========================================="
          Write-Host "âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ"
          Write-Host "ç”¨æˆ·å: RDPUser"
          Write-Host "å¯†ç : $password"
          Write-Host "=========================================="
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "RDP_USERNAME=RDPUser" >> $env:GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

      - name: è·å–ç½‘ç»œä¿¡æ¯
        run: |
          # è·å–å…¬ç½‘IP
          try {
              $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
          } catch {
              $publicIP = "æ— æ³•è·å–"
          }
          
          # è·å–æœ¬åœ°IP
          $localIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -ne "127.0.0.1"} | Select-Object -First 1).IPAddress
          
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
          
          Write-Host "å…¬ç½‘IP: $publicIP"
          Write-Host "æœ¬åœ°IP: $localIP"

      - name: æ˜¾ç¤ºæ‰€æœ‰è¿æ¥ä¿¡æ¯ï¼ˆå¯†ç ä¼šæ˜¾ç¤ºï¼‰
        run: |
          # ä»ç¯å¢ƒå˜é‡è¯»å–
          $username = $env:RDP_USERNAME
          $password = $env:RDP_PASSWORD
          $publicIP = $env:PUBLIC_IP
          $localIP = $env:LOCAL_IP
          
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "ğŸš¨ ç«‹å³å¤åˆ¶ä»¥ä¸‹ä¿¡æ¯ï¼å¯†ç ä¼šæ˜¾ç¤ºåœ¨æ­¤ ğŸš¨"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ‘¤ ç”¨æˆ·å: $username"
          Write-Host "ğŸ”‘ å¯†ç : $password"
          Write-Host ""
          Write-Host "ğŸ“ è¿æ¥åœ°å€ï¼š"
          Write-Host " 1. å…¬ç½‘IP: $publicIP"
          Write-Host " 2. æœ¬åœ°IP: $localIP"
          Write-Host ""
          Write-Host "ğŸ’» è¿æ¥å‘½ä»¤ï¼š"
          Write-Host " mstsc /v:$publicIP"
          Write-Host " æˆ–"
          Write-Host " mstsc /v:$localIP"
          Write-Host ""
          Write-Host "â° ä¼šè¯æ—¶é•¿: ${{ inputs.session_timeout }} åˆ†é’Ÿ"
          Write-Host ""
          Write-Host "ğŸ“ æ³¨æ„ï¼šæ­¤ä¿¡æ¯ä»…åœ¨æœ¬æ¬¡è¿è¡Œä¸­æœ‰æ•ˆï¼"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: ä¿æŒä¼šè¯
        run: |
          $startTime = Get-Date
          $endTime = (Get-Date).AddMinutes(${{ inputs.session_timeout }})
          
          Write-Host "ä¼šè¯å·²å¯åŠ¨ï¼Œå°†è¿è¡Œ ${{ inputs.session_timeout }} åˆ†é’Ÿ"
          Write-Host "ç”¨æˆ·å: $env:RDP_USERNAME"
          Write-Host "å¯†ç : $env:RDP_PASSWORD"
          Write-Host "IPåœ°å€: $env:PUBLIC_IP"
          Write-Host ""
          Write-Host "æŒ‰ Ctrl+C æˆ–å–æ¶ˆå·¥ä½œæµä»¥æå‰ç»“æŸ"
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              $minutes = [math]::Round($remaining.TotalMinutes, 1)
              
              if ([math]::Floor(((Get-Date) - $startTime).TotalSeconds) % 30 -eq 0) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] è¿è¡Œä¸­ - å‰©ä½™ $minutes åˆ†é’Ÿ"
              }
              
              Start-Sleep -Seconds 1
          }
          
          Write-Host "ä¼šè¯å·²ç»“æŸ"
