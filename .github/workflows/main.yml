name: Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      RDP_USERNAME: RDP

    steps:
      - name: ğŸ”§ Enable Remote Desktop
        run: |
          # 1. å¯ç”¨è¿œç¨‹æ¡Œé¢å¹¶å…³é—­ç½‘ç»œçº§èº«ä»½éªŒè¯ (ä¸ºäº†å…¼å®¹æ€§ï¼Œéç”Ÿäº§ç¯å¢ƒ)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # 2. é…ç½®é˜²ç«å¢™å…è®¸ 3389 ç«¯å£
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 > $null

          # 3. é‡å¯æœåŠ¡ç”Ÿæ•ˆ
          Restart-Service -Name TermService -Force
        shell: powershell

      - name: ğŸ” Generate Secure Password (Fixed)
        id: password
        run: |
          # -----------------------------------------------------------
          # å­—ç¬¦é›†æ„å»º (åˆ†æ­¥å®šä¹‰ï¼Œé¿å… PowerShell ç±»å‹æ¨æ–­é”™è¯¯)
          # -----------------------------------------------------------
          
          # å¤§å†™å­—æ¯ A-Z
          $upper = 65..90 | ForEach-Object { [char]$_ }
          
          # å°å†™å­—æ¯ a-z  
          $lower = 97..122 | ForEach-Object { [char]$_ }
          
          # æ•°å­— 0-9
          $number = 48..57 | ForEach-Object { [char]$_ }
          
          # ç‰¹æ®Šå­—ç¬¦ (æ‹†åˆ†å¤æ‚èŒƒå›´ä¸ºç®€å•èŒƒå›´ï¼Œç¡®ä¿å…¼å®¹æ€§)
          # å¯¹åº”ç¬¦å·: !#$%&*+-./:;<=>?@[]^_`{|}~
          $special = @(
            33 # !
          ) + (35..38) # # $ % &
          ) + (42..43) # * +
          ) + (45..47) # - . /
          ) + (58..64) # : ; < = > ? @
          ) + (91..96) # [ \ ] ^ _ `
          ) + (123..126) # { | } ~
          ) | ForEach-Object { [char]$_ }

          # åˆå¹¶æ‰€æœ‰å­—ç¬¦é›†
          $charSet = $upper + $lower + $number + $special

          # -----------------------------------------------------------
          # éšæœºç”Ÿæˆ 16 ä½å¯†ç 
          # -----------------------------------------------------------
          $password = -join ($charSet | Get-Random -Count 16)

          # -----------------------------------------------------------
          # è¾“å‡ºå¹¶ä¿æŠ¤å¯†ç  (é˜²æ­¢æ—¥å¿—æ³„éœ²)
          # -----------------------------------------------------------
          Write-Host "::add-mask::$password"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        shell: powershell

      - name: ğŸ‘¤ Create User Account
        run: |
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $username = "${{ env.RDP_USERNAME }}"

          # å¦‚æœç”¨æˆ·å·²å­˜åœ¨åˆ™åˆ é™¤ (é˜²æ­¢é‡è·‘å·¥ä½œæµå†²çª)
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $username
          }

          # åˆ›å»ºæ–°ç”¨æˆ·å¹¶åŠ å…¥ç®¡ç†å‘˜ç»„
          New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "Auto-created RDP account" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        shell: powershell

      - name: ğŸ“¦ Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP ailscale.msi"
          
          try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
          } catch {
            Write-Error "å®‰è£…å¤±è´¥: $_"
            exit 1
          }
        shell: powershell

      - name: ğŸŒ Connect to Tailscale
        run: |
          $tailscale = "$env:ProgramFiles\Tailscale ailscale.exe"
          if (-not (Test-Path $tailscale)) {
            Write-Error "æœªæ‰¾åˆ° Tailscale"
            exit 1
          }

          # è¿æ¥å¹¶è·å– IP
          & $tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}
          
          $ip = & $tailscale ip -4 2>$null
          if (-not $ip) {
            Write-Error "æ— æ³•è·å– IP"
            exit 1
          }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "è¿æ¥æˆåŠŸï¼ŒIP: $ip"
        shell: powershell

      - name: ğŸ–¥ï¸ Connection Info & Keep Alive
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "âœ… å‡†å¤‡å°±ç»ª! è¯·ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯è¿æ¥" -ForegroundColor Green
          Write-Host "åœ°å€: $env:TAILSCALE_IP"
          Write-Host "ç”¨æˆ·å: $env:RDP_USERNAME"
          Write-Host "å¯†ç : $env:RDP_PASSWORD" # æ—¥å¿—ä¸­ä¼šè¢«æ©ç  * å·æ›¿ä»£
          Write-Host "====================================" -ForegroundColor Green

          # ä¿æŒä¼šè¯è¿è¡Œï¼Œç›´åˆ°ä½ æ‰‹åŠ¨å–æ¶ˆ Workflow
          while ($true) {
            Write-Host "[$(Get-Date)] è¿æ¥ä¸­... (åœ¨ GitHub ä¸Šç‚¹å‡» 'Cancel' ä»¥ç»“æŸä¼šè¯)"
            Start-Sleep -Seconds 300
          }
        shell: powershell
