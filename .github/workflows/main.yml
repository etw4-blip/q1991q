name: Windows RDP Keep Alive with Password

on:
  workflow_dispatch:
    inputs:
      session_timeout:
        description: 'Session duration in minutes (10-480)'
        required: false
        default: '120'
        type: string

jobs:
  rdp-session:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON(inputs.session_timeout) }}

    steps:
      - name: Initialize Setup
        run: |
          Write-Host "ğŸš€ Starting Windows RDP Session"
          Write-Host "Workflow ID: $env:GITHUB_RUN_ID"
          Write-Host "Session Duration: ${{ inputs.session_timeout }} minutes"

      - name: Configure Remote Desktop
        run: |
          Write-Host "ğŸ”§ Configuring Remote Desktop..."
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          
          # Disable NLA for wider compatibility
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # Configure firewall
          netsh advfirewall firewall delete rule name="GitHub-RDP" 2>$null
          netsh advfirewall firewall add rule name="GitHub-RDP" dir=in action=allow protocol=TCP localport=3389 description="GitHub Actions RDP Session"
          
          # Restart service
          Restart-Service -Name TermService -Force
          
          Write-Host "âœ… Remote Desktop configured"

      - name: Generate Secure Password
        run: |
          Write-Host "ğŸ” Generating Windows-compliant password..."
          
          # Windows password requirements: at least 8 chars, uppercase, lowercase, number, special char
          $uppercase = "ABCDEFGHJKLMNPQRSTUVWXYZ"
          $lowercase = "abcdefghijkmnpqrstuvwxyz"
          $numbers = "23456789"
          $special = "!@#$%^&*"
          
          # Generate password meeting all requirements
          $password = ""
          $password += $uppercase[(Get-Random -Maximum $uppercase.Length)]
          $password += $lowercase[(Get-Random -Maximum $lowercase.Length)]
          $password += $numbers[(Get-Random -Maximum $numbers.Length)]
          $password += $special[(Get-Random -Maximum $special.Length)]
          
          # Add 4 more random characters for length
          $allChars = $uppercase + $lowercase + $numbers + $special
          for ($i = 0; $i -lt 4; $i++) {
              $password += $allChars[(Get-Random -Maximum $allChars.Length)]
          }
          
          # Shuffle the characters
          $password = -join ($password.ToCharArray() | Get-Random -Count $password.Length)
          
          # Show password (won't be masked)
          Write-Host ""
          Write-Host "========================================"
          Write-Host "ğŸ”‘ Generated Password: $password"
          Write-Host "========================================"
          Write-Host ""
          
          # Save password to file
          $password | Out-File -FilePath "$env:RUNNER_TEMP dp_password.txt" -NoNewline
          
          Write-Host "âœ… Password generated and saved"

      - name: Create User Account
        run: |
          Write-Host "ğŸ‘¤ Creating RDP user account..."
          
          # Read password from file
          $password = Get-Content "$env:RUNNER_TEMP dp_password.txt" -Raw
          
          # Create user
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Remove existing user if any
          Remove-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue
          
          # Create new user
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          Write-Host "âœ… User 'RDPUser' created successfully"
          Write-Host "ğŸ”‘ Password: $password"

      - name: Get Network Information
        run: |
          Write-Host "ğŸŒ Getting network information..."
          
          # Get public IP
          try {
              $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org" -TimeoutSec 5).Trim()
              Write-Host "âœ… Public IP: $publicIP"
          } catch {
              $publicIP = "Not available"
              Write-Host "âš ï¸ Could not get public IP"
          }
          
          # Get local IP
          $localIP = (Get-NetIPAddress -AddressFamily IPv4 | 
                      Where-Object {$_.IPAddress -ne "127.0.0.1" -and $_.PrefixOrigin -eq "Dhcp"} |
                      Select-Object -First 1).IPAddress
          
          if (-not $localIP) {
              $localIP = (Get-NetIPAddress -AddressFamily IPv4 | 
                         Where-Object {$_.IPAddress -ne "127.0.0.1"} |
                         Select-Object -First 1).IPAddress
          }
          
          Write-Host "ğŸ”— Local IP: $localIP"
          
          # Save to environment
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          echo "LOCAL_IP=$localIP" >> $env:GITHUB_ENV
          
          # Create connection info file
          $password = Get-Content "$env:RUNNER_TEMP dp_password.txt" -Raw
          $connectionInfo = @"
RDP Connection Information
============
Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
Workflow: $env:GITHUB_RUN_ID

Username: RDPUser
Password: $password

Connection Addresses:
1. Public IP: $publicIP
2. Local IP: $localIP

Connection Commands:
mstsc /v:$publicIP
or
mstsc /v:$localIP

Session Duration: ${{ inputs.session_timeout }} minutes
"@
          
          $connectionInfo | Out-File -FilePath "$env:RUNNER_TEMP\connection_info.txt"
          Write-Host "âœ… Connection info saved"

      - name: Test RDP Connection
        run: |
          Write-Host "ğŸ§ª Testing RDP port..."
          Start-Sleep -Seconds 3
          
          $portTest = Test-NetConnection -ComputerName 127.0.0.1 -Port 3389 -InformationLevel Quiet
          if ($portTest) {
              Write-Host "âœ… RDP port 3389 is open"
          } else {
              Write-Host "âš ï¸ RDP port test failed, but connection may still work"
          }

      - name: Display Connection Information
        run: |
          # Read password from file
          $password = Get-Content "$env:RUNNER_TEMP dp_password.txt" -Raw
          
          Write-Host ""
          Write-Host "ğŸš¨ğŸš¨ğŸš¨ IMPORTANT: COPY THIS INFORMATION NOW! ğŸš¨ğŸš¨ğŸš¨"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ” Login Credentials:"
          Write-Host " Username: RDPUser"
          Write-Host " Password: $password"
          Write-Host ""
          Write-Host "ğŸ“ Connection Addresses:"
          Write-Host " Public IP: $env:PUBLIC_IP"
          Write-Host " Local IP: $env:LOCAL_IP"
          Write-Host ""
          Write-Host "ğŸ’» Quick Connect Commands:"
          Write-Host " mstsc /v:$env:PUBLIC_IP"
          Write-Host " or"
          Write-Host " mstsc /v:$env:LOCAL_IP"
          Write-Host ""
          Write-Host "â° Session Information:"
          Write-Host " Duration: ${{ inputs.session_timeout }} minutes"
          Write-Host " Workflow ID: $env:GITHUB_RUN_ID"
          Write-Host ""
          Write-Host "ğŸ“ Notes:"
          Write-Host " 1. Copy the password now - window will stay open"
          Write-Host " 2. Session will run for ${{ inputs.session_timeout }} minutes"
          Write-Host " 3. To end early, click 'Cancel workflow'"
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""

      - name: Upload Connection Info for Download
        uses: actions/upload-artifact@v4
        with:
          name: rdp-connection-details
          path: |
            ${{ runner.temp }}/rdp_password.txt
            ${{ runner.temp }}/connection_info.txt
          retention-days: 1

      - name: Keep Session Running (Will Not End)
        run: |
          $startTime = Get-Date
          $timeoutMinutes = [int]${{ inputs.session_timeout }}
          $endTime = $startTime.AddMinutes($timeoutMinutes)
          
          # Display start info
          Write-Host ""
          Write-Host "ğŸŸ¢ RDP Session Started, Running..."
          Write-Host " Start Time: $startTime"
          Write-Host " End Time: $endTime"
          Write-Host " Time Remaining: $timeoutMinutes minutes"
          Write-Host ""
          
          # Show connection info again (for easy viewing)
          $password = Get-Content "$env:RUNNER_TEMP dp_password.txt" -Raw
          Write-Host "ğŸ“‹ Connection Summary:"
          Write-Host " Username: RDPUser"
          Write-Host " Password: $password"
          Write-Host " Public IP: $env:PUBLIC_IP"
          Write-Host " Local IP: $env:LOCAL_IP"
          Write-Host ""
          Write-Host "ğŸ”§ Use Remote Desktop Connection (mstsc.exe) with above info"
          Write-Host "âŒ To end session: Click 'Cancel workflow' in GitHub Actions"
          Write-Host ""
          
          # Heartbeat loop - keep workflow running
          $checkCount = 0
          while ($true) {
              $now = Get-Date
              $remaining = $endTime - $now
              
              # Check if timeout reached
              if ($remaining.TotalSeconds -le 0) {
                  Write-Host "â° Session timeout, auto-ending"
                  break
              }
              
              # Show status every minute
              if ($checkCount % 60 -eq 0) {
                  $minutesLeft = [math]::Round($remaining.TotalMinutes, 1)
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Session Active - $minutesLeft minutes left"
                  
                  # Check service status every 5 minutes
                  if ($checkCount % 300 -eq 0) {
                      $rdpService = Get-Service TermService -ErrorAction SilentlyContinue
                      if ($rdpService.Status -ne 'Running') {
                          Write-Host "âš ï¸ RDP service stopped, restarting..."
                          Start-Service TermService -Force -ErrorAction SilentlyContinue
                      }
                  }
              }
              
              $checkCount++
              Start-Sleep -Seconds 1 # Check every second
          }
          
          Write-Host "ğŸ›‘ Session ended at $(Get-Date)"
