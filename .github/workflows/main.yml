name: Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      RDP_USERNAME: RDP

    steps:
      - name: ğŸ”§ Enable Remote Desktop
        run: |
          # 1. å¯ç”¨è¿œç¨‹æ¡Œé¢å¹¶å…³é—­ç½‘ç»œçº§èº«ä»½éªŒè¯
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # 2. é…ç½®é˜²ç«å¢™
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 > $null

          # 3. é‡å¯æœåŠ¡
          Restart-Service -Name TermService -Force
        shell: powershell

      - name: ğŸ” Generate Secure Password (Fully Fixed)
        id: password
        run: |
          # -----------------------------------------------------------
          # å®šä¹‰å­—ç¬¦é›† (ä½¿ç”¨æœ€åŸºç¡€çš„æ•°ç»„è¯­æ³•ï¼Œé¿å…è§£æé”™è¯¯)
          # -----------------------------------------------------------
          
          # å¤§å†™å­—æ¯ A-Z (ASCII 65-90)
          $upper = 65..90 | ForEach-Object { [char]$_ }
          
          # å°å†™å­—æ¯ a-z (ASCII 97-122)
          $lower = 97..122 | ForEach-Object { [char]$_ }
          
          # æ•°å­— 0-9 (ASCII 48-57)
          $number = 48..57 | ForEach-Object { [char]$_ }
          
          # ç‰¹æ®Šå­—ç¬¦ (æ‰‹åŠ¨åˆ—å‡ºæ‰€æœ‰ ASCII ç ï¼Œç»å¯¹å®‰å…¨)
          $special = 33,35,36,37,38,42,43,45,46,47,58,59,60,61,62,63,64,91,92,93,94,95,96,123,124,125,126 | ForEach-Object { [char]$_ }

          # åˆå¹¶æ‰€æœ‰å­—ç¬¦
          $allChars = $upper + $lower + $number + $special

          # -----------------------------------------------------------
          # ç”Ÿæˆ 16 ä½éšæœºå¯†ç 
          # -----------------------------------------------------------
          $password = -join ($allChars | Get-Random -Count 16)

          # -----------------------------------------------------------
          # è¾“å‡ºå¹¶ä¿æŠ¤å¯†ç 
          # -----------------------------------------------------------
          Write-Host "::add-mask::$password"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        shell: powershell

      - name: ğŸ‘¤ Create User Account
        run: |
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $username = "$"

          # æ¸…ç†æ—§ç”¨æˆ· (å¦‚æœå­˜åœ¨)
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $username
          }

          # åˆ›å»ºæ–°ç”¨æˆ·å¹¶ææƒ
          New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "Auto-created RDP account" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        shell: powershell

      - name: ğŸ“¦ Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP ailscale.msi"
          
          try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
          } catch {
            Write-Error "å®‰è£…å¤±è´¥: $_"
            exit 1
          }
        shell: powershell

      - name: ğŸŒ Connect to Tailscale
        run: |
          $tailscale = "$env:ProgramFiles\Tailscale ailscale.exe"
          if (-not (Test-Path $tailscale)) {
            Write-Error "æœªæ‰¾åˆ° Tailscale"
            exit 1
          }

          # è¿æ¥èŠ‚ç‚¹
          & $tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}
          
          # è·å– IP åœ°å€
          $ip = & $tailscale ip -4 2>$null
          if (-not $ip) {
            Write-Error "æ— æ³•è·å– IP"
            exit 1
          }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "è¿æ¥æˆåŠŸï¼ŒIP: $ip"
        shell: powershell

      - name: ğŸ–¥ï¸ Connection Info & Keep Alive
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "âœ… å‡†å¤‡å°±ç»ª! è¯·ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯è¿æ¥" -ForegroundColor Green
          Write-Host "åœ°å€: $env:TAILSCALE_IP"
          Write-Host "ç”¨æˆ·å: $env:RDP_USERNAME"
          Write-Host "å¯†ç : $env:RDP_PASSWORD" # ä¼šè¢«æ©ç 
          Write-Host "====================================" -ForegroundColor Green

          # ä¿æŒè¿è¡Œ
