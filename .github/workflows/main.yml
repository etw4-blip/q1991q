name: Secure RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      RDP_USERNAME: RDP

    steps:
      - name: üîß Configure RDP Settings
        run: |
          # Enable Remote Desktop and disable NLA/Security Layer for simplicity (not for production!)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # Remove existing firewall rule
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1

          # Allow RDP port via firewall
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 > $null

          # Restart service to apply changes
          Restart-Service -Name TermService -Force
        shell: powershell

      - name: üîê Generate & Set Random Password
        id: password
        run: |
          # Fixed: Use pipeline to correctly convert int to char
          $charSet = @{
            Upper = 65..90 | ForEach-Object { [char]$_ } # A-Z
            Lower = 97..122 | ForEach-Object { [char]$_ } # a-z
            Number = 48..57 | ForEach-Object { [char]$_ } # 0-9
            Special = @(33,35..38,42..43,45..47,58..64,91..96,123..126) | ForEach-Object { [char]$_ } # !#$%&*+-./:;<=>?@[]^_`{|}~
          }

          $password = @()
          $password += Get-Random -InputObject $charSet.Upper -Count 4
          $password += Get-Random -InputObject $charSet.Lower -Count 4
          $password += Get-Random -InputObject $charSet.Number -Count 4
          $password += Get-Random -InputObject $charSet.Special -Count 4
          
          # Shuffle the final password
          $password = ($password | Sort-Object { Get-Random }) -join ''

          # Mask password in logs and set to environment
          Write-Host "::add-mask::$password"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        shell: powershell

      - name: üë§ Create RDP User
        run: |
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $username = "${{ env.RDP_USERNAME }}"
          
          # Remove user if exists
          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $username
          }
          
          # Create user and add to groups
          New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "Auto-created RDP account" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        shell: powershell

      - name: üì¶ Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP ailscale.msi"
          
          try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
          } catch {
            Write-Error "Failed to install Tailscale: $_"
            exit 1
          }
        shell: powershell

      - name: üåê Connect to Tailscale
        run: |
          $tailscale = "$env:ProgramFiles\Tailscale ailscale.exe"
          if (-not (Test-Path $tailscale)) {
            Write-Error "Tailscale not installed at $tailscale"
            exit 1
          }

          & $tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-${{ github.run_id }}
          
          # Wait for IP with timeout
          $ip = $null
          for ($i = 0; $i -lt 10; $i++) {
            $ip = & $tailscale ip -4 2>$null
            if ($ip) { break }
            Start-Sleep -Seconds 6
          }

          if (-not $ip) {
            Write-Error "Could not obtain Tailscale IP"
            exit 1
          }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip"
        shell: powershell

      - name: üß™ Verify RDP Port Accessibility
        run: |
          $result = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -InformationLevel Quiet
          if (-not $result) {
            Write-Error "RDP port 3389 is not reachable"
            exit 1
          }
          Write-Host " Port 3389 is open and accessible"
        shell: powershell

      - name: üñ•Ô∏è RDP Connection Info (Keep Alive)
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "‚úÖ RDP Access Ready!" -ForegroundColor Green
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USERNAME"
          Write-Host "Password: $env:RDP_PASSWORD" # This is masked due to add-mask
          Write-Host "====================================" -ForegroundColor Green

          # Keep runner alive
          while ($true) {
            Write-Host "[$(Get-Date)] Session active. Press Cancel in GitHub Actions to terminate."
            Start-Sleep -Seconds 300
          }
        shell: powershell
