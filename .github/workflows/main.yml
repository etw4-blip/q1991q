name: Secure RDP via Tailscale
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600
    env:
      TAILSCALE_MSI_URL: "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
      RDP_PORT: 3389
      TS_RETRY_LIMIT: 15
      TS_RETRY_DELAY: 3
      KEEPALIVE_INTERVAL: 300

    steps:
      - name: ğŸ”§ Configure RDP Core Settings
        run: |
          # å¯ç”¨RDPå¹¶é…ç½®å®‰å…¨å±‚ï¼ˆä¿æŒå…¼å®¹æ€§åŒæ—¶å‡å°‘æš´éœ²é¢ï¼‰
          $rdpRegPath = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
          $rdpTcpRegPath = "$rdpRegPath\WinStations\RDP-Tcp"
          
          Set-ItemProperty -Path $rdpRegPath -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path $rdpTcpRegPath -Name "UserAuthentication" -Value 1 -Force # æ¢å¤ç½‘ç»œçº§è®¤è¯ï¼ˆæå‡å®‰å…¨æ€§ï¼‰
          Set-ItemProperty -Path $rdpTcpRegPath -Name "SecurityLayer" -Value 2 -Force # ä½¿ç”¨TLSå®‰å…¨å±‚
          
          # æ¸…ç†æ—§é˜²ç«å¢™è§„åˆ™å¹¶åˆ›å»ºé™å®šè§„åˆ™
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>&1 | Out-Null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=$env:RDP_PORT remoteip="100.64.0.0/10" profile=any # ä»…å…è®¸Tailscaleç½‘æ®µè®¿é—®
          
          # é‡å¯ç»ˆç«¯æœåŠ¡ç¡®ä¿é…ç½®ç”Ÿæ•ˆ
          Restart-Service -Name TermService -Force -ErrorAction Stop
        error-message: "RDPé…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™å’Œæ³¨å†Œè¡¨è·¯å¾„"

      - name: ğŸ‘¤ Create Secure RDP User
        run: |
          Add-Type -AssemblyName System.Security
          
          # å¯†ç ç­–ç•¥å¼ºåŒ–ï¼ˆ16ä½å«å››ç±»å­—ç¬¦ï¼Œé¿å…é‡å¤ï¼‰
          $charSets = @(
              [char[]](65..90), # å¤§å†™å­—æ¯
              [char[]](97..122), # å°å†™å­—æ¯
              [char[]](48..57), # æ•°å­—
              [char[]](33..47 + 58..64 + 91..96 + 123..126) # ç‰¹æ®Šå­—ç¬¦
          )
          
          $rawPassword = $charSets | ForEach-Object { $_ | Get-Random -Count 4 } | Get-Random
          $password = -join $rawPassword
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # åŸå­åŒ–ç”¨æˆ·åˆ›å»ºï¼ˆé¿å…æ®‹ç•™ï¼‰
          if (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name "RDP" -Force
          }
          New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -UserMayNotChangePassword -ErrorAction Stop
          Add-LocalGroupMember -Group @("Administrators", "Remote Desktop Users") -Member "RDP" -ErrorAction Stop
          
          # å®‰å…¨å­˜å‚¨å‡­æ®ï¼ˆä»… workflow å¯è§ï¼‰
          echo "RDP_USER=RDP" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
        error-message: "RDPç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿è¡Œå™¨æƒé™"

      - name: ğŸ“¥ Install Tailscale
        run: |
          $installerPath = "$env:TEMP ailscale.msi"
          
          # ä¸‹è½½é‡è¯•æœºåˆ¶
          $downloadSuccess = $false
          for ($i=1; $i -le 3; $i++) {
              try {
                  Invoke-WebRequest -Uri $env:TAILSCALE_MSI_URL -OutFile $installerPath -UseBasicParsing -ErrorAction Stop
                  $downloadSuccess = $true
                  break
              }
              catch {
                  Write-Warning "ä¸‹è½½å¤±è´¥ï¼Œç¬¬$iæ¬¡é‡è¯•..."
                  Start-Sleep -Seconds 5
              }
          }
          if (-not $downloadSuccess) { throw "Tailscaleå®‰è£…åŒ…ä¸‹è½½å¤±è´¥" }
          
          # é™é»˜å®‰è£…å¹¶æ¸…ç†å®‰è£…åŒ…
          Start-Process msiexec.exe -ArgumentList "/i `"$installerPath`" /quiet /norestart /qn" -Wait -NoNewWindow
          Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
        error-message: "Tailscaleå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"

      - name: ğŸ–§ Establish Tailscale Connection
        run: |
          $tailscaleExe = "$env:ProgramFiles\Tailscale ailscale.exe"
          if (-not (Test-Path $tailscaleExe)) { throw "Tailscaleå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°" }
          
          # å¯åŠ¨Tailscaleå¹¶ç»‘å®šå”¯ä¸€ä¸»æœºå
          & $tailscaleExe up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname="gh-rdp-runner-$env:GITHUB_RUN_ID" --accept-routes --accept-dns
          
          # ç­‰å¾…IPåˆ†é…ï¼ˆå¸¦è¶…æ—¶é‡è¯•ï¼‰
          $tsIP = $null
          for ($i=1; $i -le $env:TS_RETRY_LIMIT; $i++) {
              $tsIP = & $tailscaleExe ip -4 | Select-Object -First 1
              if ($tsIP) { break }
              Write-Host "ç­‰å¾…Tailscale IPåˆ†é…ï¼ˆç¬¬$iæ¬¡é‡è¯•ï¼‰..."
              Start-Sleep -Seconds $env:TS_RETRY_DELAY
          }
          if (-not $tsIP) { throw "Tailscale IPåˆ†é…è¶…æ—¶" }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "Tailscale IPå·²åˆ†é…: $tsIP"
        error-message: "Tailscaleè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¤è¯å¯†é’¥å’Œç½‘ç»œ"

      - name: âœ… Verify RDP Connectivity
        run: |
          Write-Host "æ­£åœ¨éªŒè¯RDPè¿æ¥: $env:TAILSCALE_IP`:$env:RDP_PORT"
          
          # ç«¯å£è¿é€šæ€§æµ‹è¯•ï¼ˆå¸¦è¶…æ—¶ï¼‰
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port $env:RDP_PORT -InformationLevel Quiet -ErrorAction Stop
          if (-not $testResult) { throw "RDPç«¯å£$env:RDP_PORTè¿é€šæ€§æµ‹è¯•å¤±è´¥" }
          
          Write-Host "âœ… RDPç«¯å£è¿é€šæ€§æµ‹è¯•æˆåŠŸï¼"
        error-message: "RDPè¿é€šæ€§éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™è§„åˆ™å’ŒTailscaleè¿æ¥"

      - name: ğŸš€ Maintain RDP Session
        run: |
          Write-Host "`n====================================="
          Write-Host "ğŸ“Œ RDPè®¿é—®ä¿¡æ¯"
          Write-Host "åœ°å€: $env:TAILSCALE_IP"
          Write-Host "ç”¨æˆ·å: $env:RDP_USER"
          Write-Host "å¯†ç : $env:RDP_PASS"
          Write-Host "ç«¯å£: $env:RDP_PORT"
          Write-Host "=====================================`n"
          
          # ä¿æ´»å¾ªç¯ï¼ˆå¸¦æ—¶é—´æˆ³å’Œèµ„æºç›‘æ§ï¼‰
          while ($true) {
              $cpuUsage = Get-Counter -Counter "\Processor(_Total)\% Processor Time" -SampleInterval 1 -MaxSamples 1 | Select-Object -ExpandProperty CounterSamples | Select-Object -ExpandProperty CookedValue
              Write-Host "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] RDPä¼šè¯æ´»è·ƒ | CPUä½¿ç”¨ç‡: $($cpuUsage.ToString('F1'))%"
              Start-Sleep -Seconds $env:KEEPALIVE_INTERVAL
          }
        error-message: "RDPä¼šè¯ä¿æ´»å¤±è´¥"
