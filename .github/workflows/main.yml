name: Windows RDP with Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      RDP_USERNAME: RDP

    steps:
      - name: üõ†Ô∏è Configure Console Encoding
        run: |
          # Force UTF-8 mode for the console to prevent mojibake (garbled text)
          chcp 65001
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          $OutputEncoding = [System.Text.Encoding]::UTF8
        shell: powershell

      - name: üîß Enable Remote Desktop
        run: |
          Write-Host "[Step 1/6] Enabling Remote Desktop..." -ForegroundColor Yellow
          
          # 1. ÂêØÁî®ËøúÁ®ãÊ°åÈù¢
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force

          # 2. Èò≤ÁÅ´Â¢ô
          netsh advfirewall firewall delete rule name="RDP-Tailscale" > $null 2>&1
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 > $null

          # 3. ÈáçÂêØÊúçÂä°
          Restart-Service -Name TermService -Force
        shell: powershell

      - name: üîê Generate Secure Password
        id: password
        run: |
          Write-Host "[Step 2/6] Generating Password..." -ForegroundColor Yellow

          # ÂÆö‰πâÂ≠óÁ¨¶ÈõÜ (‰ΩøÁî®ÂÆâÂÖ®ÁöÑÊï∞ÁªÑÂÆö‰πâ)
          $upper = 65..90 | ForEach-Object { [char]$_ }
          $lower = 97..122 | ForEach-Object { [char]$_ }
          $number = 48..57 | ForEach-Object { [char]$_ }
          $special = 33,35,36,37,38,42,43,45,46,47,58,59,60,61,62,63,64,91,92,93,94,95,96,123,124,125,126 | ForEach-Object { [char]$_ }

          # ÁîüÊàêÂØÜÁ†Å
          $allChars = $upper + $lower + $number + $special
          $password = -join ($allChars | Get-Random -Count 16)

          # Â±èËîΩÂØÜÁ†Å
          Write-Host "::add-mask::$password"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
        shell: powershell

      - name: üë§ Create User Account
        run: |
          Write-Host "[Step 3/6] Creating User..." -ForegroundColor Yellow
          
          $securePass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          $username = "$"

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $username
          }

          New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "Auto-created RDP account" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        shell: powershell

      - name: üì¶ Install Tailscale
        run: |
          Write-Host "[Step 4/6] Installing Tailscale..." -ForegroundColor Yellow
          
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP ailscale.msi"
          
          try {
            Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing
            Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait -NoNewWindow
            Remove-Item $installerPath -Force
          } catch {
            Write-Error "Install Failed: $_"
            exit 1
          }
        shell: powershell

      - name: üåê Connect to Tailscale
        run: |
          Write-Host "[Step 5/6] Connecting to Tailscale..." -ForegroundColor Yellow
          
          $tailscaleExe = [System.IO.Path]::Combine($env:ProgramFiles, "Tailscale", "tailscale.exe")
          
          if (-not (Test-Path $tailscaleExe)) {
            Write-Error "Tailscale not found!"
            exit 1
          }

          & $tailscaleExe up --authkey=$ --hostname=gh-runner-${{ github.run_id }}
          $ip = & $tailscaleExe ip -4 2>$null
          if (-not $ip) {
            Write-Error "No IP obtained!"
            exit 1
          }

          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Connected. IP: $ip"
        shell: powershell

      - name: üñ•Ô∏è Connection Info & Keep Alive
        run: |
          Write-Host "====================================" -ForegroundColor Green
          Write-Host "READY! Connect using the info below:" -ForegroundColor Green
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USERNAME"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host "====================================" -ForegroundColor Green

          while ($true) {
            Write-Host "[$(Get-Date)] Session active. Cancel workflow to terminate."
            Start-Sleep -Seconds 300
          }
        shell: powershell
